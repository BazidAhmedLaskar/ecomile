<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Profile - EcoMiles</title>
        <meta
            name="description"
            content="View your EcoMiles profile, journey history, and account information."
        />
        <link rel="stylesheet" href="css/styles.css" />
    </head>
    <body>
        <header>
            <nav class="navbar">
                <div class="nav-container">
                    <div class="logo">
                        <h1>
                            <a
                                href="dashboard.html"
                                style="text-decoration: none; color: inherit"
                                >üå± EcoMiles</a
                            >
                        </h1>
                    </div>
                    <div class="profile-menu">
                        <div class="profile-avatar" id="profileAvatar" onclick="toggleProfileMenu()">
                            <img id="profileAvatarImg" src="" alt="Profile" class="profile-avatar-img">
                        </div>
                        <div class="nav-dropdown" id="navDropdown">
                            <ul>
                                <li><a href="dashboard.html"><span class="nav-icon">üè†</span>Dashboard</a></li>
                                <li><a href="journey.html"><span class="nav-icon">‚ûï</span>Add Journey</a></li>
                                <li><a href="leaderboard.html"><span class="nav-icon">üèÜ</span>Leaderboard</a></li>
                                <li><a href="rewards.html"><span class="nav-icon">üéñÔ∏è</span>Rewards</a></li>
                                <li><a href="profile.html"><span class="nav-icon">üë§</span>Profile</a></li>
                                <li><a href="qr-scanner.html"><span class="nav-icon">üì±</span>QR Scanner</a></li>
                                <div class="nav-divider"></div>
                                <li class="logout-item"><a href="#" onclick="logout()"><span class="nav-icon">üö™</span>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <main>
            <div class="container">
                <!-- Profile Header -->
                <div
                    style="
                        background: linear-gradient(
                            135deg,
                            #28a745 0%,
                            #20c997 100%
                        );
                        color: white;
                        padding: 40px;
                        border-radius: 16px;
                        margin: 40px 0;
                        text-align: center;
                    "
                >
                    <div
                        style="
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            gap: 20px;
                        "
                    >
                        <img
                            id="profileAvatar"
                            src=""
                            alt="Profile Picture"
                            style="
                                width: 100px;
                                height: 100px;
                                border-radius: 50%;
                                border: 4px solid white;
                                display: none;
                            "
                        />
                        <div>
                            <h2 id="profileName" style="margin-bottom: 10px">
                                Loading...
                            </h2>
                            <p
                                id="profileEmail"
                                style="opacity: 0.9; margin-bottom: 0"
                            ></p>
                        </div>
                    </div>
                </div>

                <!-- Privacy Settings -->
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 16px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                    margin: 40px 0;
                ">
                    <h3 style="margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px;">
                        üîí Privacy Settings
                    </h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee;">
                        <div>
                            <strong style="color: #333;">Show in Leaderboard</strong>
                            <p style="color: #666; margin: 5px 0 0 0; font-size: 0.9rem;">Allow others to see your ranking and score on the public leaderboard</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="leaderboardToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Profile Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üå±</div>
                        <div class="stat-value" id="profilePoints">0</div>
                        <div class="stat-label">Total EcoPoints</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìè</div>
                        <div class="stat-value" id="profileDistance">0 km</div>
                        <div class="stat-label">Distance Traveled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üóìÔ∏è</div>
                        <div class="stat-value" id="profileJourneys">0</div>
                        <div class="stat-label">Total Journeys</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üåç</div>
                        <div class="stat-value" id="profileCO2">0 kg</div>
                        <div class="stat-label">CO‚ÇÇ Saved</div>
                    </div>
                </div>

                <!-- Journey History -->
                <div
                    style="
                        background: white;
                        padding: 40px;
                        border-radius: 16px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                        margin: 40px 0;
                    "
                >
                    <div
                        style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 30px;
                        "
                    >
                        <h3 style="color: #333; margin: 0">Journey History</h3>
                        <button
                            id="showAllJourneys"
                            class="btn-secondary"
                            style="padding: 8px 16px; font-size: 0.9rem"
                        >
                            Show All
                        </button>
                    </div>

                    <div id="journeyHistoryContainer">
                        <div id="journeyHistoryList">
                            <p
                                style="
                                    text-align: center;
                                    color: #666;
                                    padding: 40px;
                                "
                            >
                                Loading journey history...
                            </p>
                        </div>

                        <div
                            id="journeyPagination"
                            style="
                                display: none;
                                text-align: center;
                                margin-top: 30px;
                            "
                        >
                            <button
                                id="prevPage"
                                class="btn-secondary"
                                style="margin: 0 10px"
                            >
                                Previous
                            </button>
                            <span
                                id="pageInfo"
                                style="margin: 0 20px; color: #666"
                            ></span>
                            <button
                                id="nextPage"
                                class="btn-secondary"
                                style="margin: 0 10px"
                            >
                                Next
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Account Actions -->
                <div
                    style="
                        background: #f8f9fa;
                        padding: 40px;
                        border-radius: 16px;
                        margin: 40px 0;
                    "
                >
                    <h3
                        style="
                            text-align: center;
                            color: #333;
                            margin-bottom: 30px;
                        "
                    >
                        Account Actions
                    </h3>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: repeat(
                                auto-fit,
                                minmax(250px, 1fr)
                            );
                            gap: 20px;
                        "
                    >
                        <button
                            id="downloadDataBtn"
                            class="action-btn"
                            style="background: #17a2b8"
                        >
                            üì• Download My Data
                        </button>
                        <button
                            id="clearDataBtn"
                            class="action-btn"
                            style="background: #dc3545"
                        >
                            üóëÔ∏è Clear All Data
                        </button>
                        <button
                            id="logoutBtn2"
                            class="action-btn"
                            style="background: #6c757d"
                        >
                            üö™ Logout
                        </button>
                    </div>

                    <div
                        style="
                            text-align: center;
                            margin-top: 30px;
                            padding-top: 30px;
                            border-top: 1px solid #dee2e6;
                        "
                    >
                        <p
                            style="
                                color: #666;
                                font-size: 0.9rem;
                                margin-bottom: 10px;
                            "
                        >
                            Member since: <span id="memberSince">--</span>
                        </p>
                        <p
                            style="
                                color: #666;
                                font-size: 0.9rem;
                                font-style: italic;
                            "
                        >
                            Your data is securely stored and only used to
                            provide EcoMiles services.
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Firebase Scripts (Compat Version) -->
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

        <!-- Firebase Configuration -->
        <script src="js/firebase-config.js"></script>
        
        <!-- Global Navigation -->
        <script src="js/navigation.js"></script>

        <!-- Profile Logic -->
        <script>
            let currentPage = 1;
            const journeysPerPage = 10;
            let totalJourneys = 0;
            let allJourneys = [];

            document.addEventListener("DOMContentLoaded", () => {
                // Wait for Firebase to load, then check authentication
                const initializeWhenReady = () => {
                    if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                        firebase.auth().onAuthStateChanged(async (user) => {
                            if (user) {
                                console.log('User authenticated:', user.uid);
                                // Setup logout functionality
                                document
                                    .getElementById("logoutBtn")
                                    .addEventListener("click", logout);
                                document
                                    .getElementById("logoutBtn2")
                                    .addEventListener("click", logout);

                                // Setup other actions
                                setupProfileActions();

                                // Load profile data
                                await loadProfileData();
                            } else {
                                console.log('No user found, redirecting to login');
                                window.location.href = 'login.html';
                            }
                        });
                    } else {
                        // Wait for Firebase to load
                        setTimeout(initializeWhenReady, 500);
                    }
                };
                
                initializeWhenReady();
            });

            function setupProfileActions() {
                document
                    .getElementById("showAllJourneys")
                    .addEventListener("click", toggleJourneyView);
                document
                    .getElementById("downloadDataBtn")
                    .addEventListener("click", downloadUserData);
                document
                    .getElementById("clearDataBtn")
                    .addEventListener("click", clearUserData);
                document
                    .getElementById("prevPage")
                    .addEventListener("click", () => changePage(-1));
                document
                    .getElementById("nextPage")
                    .addEventListener("click", () => changePage(1));
            }

            async function loadProfileData() {
                try {
                    const user = getCurrentUser();
                    if (!user) return;

                    // Update profile header
                    updateProfileHeader(user);

                    // Load user stats from Firestore
                    const userRef = db.collection("users").doc(user.uid);
                    const userDoc = await userRef.get();

                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        updateProfileStats(userData);

                        // Update member since date
                        if (userData.createdAt) {
                            const createdDate = userData.createdAt.toDate();
                            document.getElementById("memberSince").textContent =
                                createdDate.toLocaleDateString();
                        }
                    }

                    // Load journey history
                    await loadJourneyHistory(user.uid);
                } catch (error) {
                    console.error("Error loading profile data:", error);
                    showError(
                        "Unable to load profile data. Please try refreshing the page.",
                    );
                }
            }

            function updateProfileHeader(user) {
                document.getElementById("profileName").textContent =
                    user.name || "User";
                document.getElementById("profileEmail").textContent =
                    user.email || "";

                const avatar = document.getElementById("profileAvatar");
                if (user.photoURL) {
                    avatar.src = user.photoURL;
                    avatar.style.display = "block";
                }
            }

            function updateProfileStats(userData) {
                const points = userData.points || 0;
                const distance = userData.totalDistance || 0;
                const co2Saved = (distance * 0.21).toFixed(1);

                document.getElementById("profilePoints").textContent =
                    points.toLocaleString();
                document.getElementById("profileDistance").textContent =
                    `${distance.toFixed(1)} km`;
                document.getElementById("profileCO2").textContent =
                    `${co2Saved} kg`;
            }

            async function loadJourneyHistory(userId, showAll = false) {
                try {
                    const journeysRef = db
                        .collection("journeys")
                        .where("userId", "==", userId)
                        .orderBy("timestamp", "desc");

                    const snapshot = await journeysRef.get();

                    allJourneys = [];
                    snapshot.forEach((doc) => {
                        allJourneys.push({ id: doc.id, ...doc.data() });
                    });

                    totalJourneys = allJourneys.length;

                    // Update journey count
                    document.getElementById("profileJourneys").textContent =
                        totalJourneys;

                    if (totalJourneys === 0) {
                        document.getElementById(
                            "journeyHistoryList",
                        ).innerHTML = `
                        <p style="text-align: center; color: #666; padding: 40px;">
                            No journeys yet. <a href="journey.html">Add your first journey!</a>
                        </p>
                    `;
                        return;
                    }

                    // Display journeys (paginated or limited)
                    displayJourneys(showAll);
                } catch (error) {
                    console.error("Error loading journey history:", error);
                    document.getElementById("journeyHistoryList").innerHTML = `
                    <p style="text-align: center; color: #721c24; padding: 40px;">
                        Unable to load journey history. Please try again.
                    </p>
                `;
                }
            }

            function displayJourneys(showAll = false) {
                const journeysList =
                    document.getElementById("journeyHistoryList");
                const pagination = document.getElementById("journeyPagination");

                let journeysToShow;

                if (showAll) {
                    const startIndex = (currentPage - 1) * journeysPerPage;
                    const endIndex = startIndex + journeysPerPage;
                    journeysToShow = allJourneys.slice(startIndex, endIndex);

                    // Update pagination
                    const totalPages = Math.ceil(
                        totalJourneys / journeysPerPage,
                    );
                    updatePagination(totalPages);
                    pagination.style.display =
                        totalPages > 1 ? "block" : "none";
                } else {
                    journeysToShow = allJourneys.slice(0, 5);
                    pagination.style.display = "none";
                }

                let journeysHtml = "";
                journeysToShow.forEach((journey) => {
                    const date = journey.timestamp
                        ? journey.timestamp.toDate()
                        : new Date();
                    const modeEmoji = getModeEmoji(journey.mode);

                    journeysHtml += `
                    <div style="background: #f8f9fa; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                                    ${modeEmoji} ${journey.mode.charAt(0).toUpperCase() + journey.mode.slice(1)} Journey
                                </div>
                                <div style="color: #666; font-size: 0.9rem;">
                                    ${date.toLocaleDateString()} at ${date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
                                </div>
                                ${journey.notes ? `<div style="color: #666; font-size: 0.9rem; margin-top: 5px; font-style: italic;">"${journey.notes}"</div>` : ""}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: #28a745; font-size: 1.1rem;">
                                    +${journey.points} points
                                </div>
                                <div style="color: #666; font-size: 0.9rem;">
                                    ${journey.distance.toFixed(1)} km
                                </div>
                                <div style="color: #666; font-size: 0.8rem;">
                                    ${journey.type === "gps" ? "üìç GPS" : "üìù Manual"}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                });

                journeysList.innerHTML = journeysHtml;
            }

            function getModeEmoji(mode) {
                const emojiMap = {
                    walk: "üö∂",
                    cycle: "üö¥",
                    bus: "üöå",
                    carpool: "üöò",
                    train: "üöÜ",
                    metro: "üöá",
                };
                return emojiMap[mode] || "üö∂";
            }

            function toggleJourneyView() {
                const btn = document.getElementById("showAllJourneys");
                const isShowingAll = btn.textContent === "Show Less";

                if (isShowingAll) {
                    btn.textContent = "Show All";
                    currentPage = 1;
                    displayJourneys(false);
                } else {
                    btn.textContent = "Show Less";
                    displayJourneys(true);
                }
            }

            function updatePagination(totalPages) {
                const pageInfo = document.getElementById("pageInfo");
                const prevBtn = document.getElementById("prevPage");
                const nextBtn = document.getElementById("nextPage");

                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
            }

            function changePage(direction) {
                const totalPages = Math.ceil(totalJourneys / journeysPerPage);
                const newPage = currentPage + direction;

                if (newPage >= 1 && newPage <= totalPages) {
                    currentPage = newPage;
                    displayJourneys(true);
                }
            }

            async function downloadUserData() {
                try {
                    const user = getCurrentUser();
                    if (!user) return;

                    const userRef = db.collection("users").doc(user.uid);
                    const userDoc = await userRef.get();
                    const userData = userDoc.exists ? userDoc.data() : {};

                    const exportData = {
                        profile: {
                            name: user.name,
                            email: user.email,
                            uid: user.uid,
                            ...userData,
                        },
                        journeys: allJourneys,
                        exportDate: new Date().toISOString(),
                    };

                    // Download as JSON file
                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], {
                        type: "application/json",
                    });
                    const url = URL.createObjectURL(dataBlob);

                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `ecomiles-data-${new Date().toISOString().split("T")[0]}.json`;
                    link.click();

                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Error downloading data:", error);
                    alert("Failed to download data. Please try again.");
                }
            }

            async function clearUserData() {
                if (
                    !confirm(
                        "Are you sure you want to clear all your data? This action cannot be undone.",
                    )
                ) {
                    return;
                }

                if (
                    !confirm(
                        "This will permanently delete all your journeys and reset your points. Are you absolutely sure?",
                    )
                ) {
                    return;
                }

                try {
                    const user = getCurrentUser();
                    if (!user) return;

                    const clearBtn = document.getElementById("clearDataBtn");
                    clearBtn.disabled = true;
                    clearBtn.textContent = "Clearing Data...";

                    // Delete all journeys
                    const batch = db.batch();
                    allJourneys.forEach((journey) => {
                        const journeyRef = db
                            .collection("journeys")
                            .doc(journey.id);
                        batch.delete(journeyRef);
                    });

                    // Reset user stats
                    const userRef = db.collection("users").doc(user.uid);
                    batch.update(userRef, {
                        points: 0,
                        totalDistance: 0,
                        roadTaxSaved: 0,
                    });

                    await batch.commit();

                    alert("All data has been cleared successfully.");
                    window.location.reload();
                } catch (error) {
                    console.error("Error clearing data:", error);
                    alert("Failed to clear data. Please try again.");

                    const clearBtn = document.getElementById("clearDataBtn");
                    clearBtn.disabled = false;
                    clearBtn.textContent = "üóëÔ∏è Clear All Data";
                }
            }

            function showError(message) {
                const errorDiv = document.createElement("div");
                errorDiv.style.cssText =
                    "position: fixed; top: 20px; right: 20px; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; z-index: 1000; max-width: 300px;";
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);

                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
        // Profile Menu Toggle
        function toggleProfileMenu() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profileMenu = document.querySelector('.profile-menu');
            const dropdown = document.getElementById('profileDropdown');
            
            if (!profileMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Update profile avatar with user data
        function updateProfileAvatar() {
            const user = getCurrentUser();
            if (user && user.photoURL) {
                const profileAvatarImg = document.getElementById('profileAvatarImg');
                if (profileAvatarImg) {
                    profileAvatarImg.src = user.photoURL;
                }
            }
        }

        // Update profile avatar when page loads
        setTimeout(updateProfileAvatar, 1000);

        // Privacy Settings Functions
        async function initializePrivacySettings() {
            try {
                const user = getCurrentUser();
                if (user) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const toggle = document.getElementById('leaderboardToggle');
                        if (toggle) {
                            toggle.checked = userData.showInLeaderboard !== false; // Default to true
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading privacy settings:', error);
            }
        }

        // Handle toggle change
        document.addEventListener('DOMContentLoaded', function() {
            const toggle = document.getElementById('leaderboardToggle');
            if (toggle) {
                toggle.addEventListener('change', async function() {
                    try {
                        const user = getCurrentUser();
                        if (user) {
                            const success = await updateUserPrivacy(user.uid, toggle.checked);
                            if (success) {
                                showMessage(
                                    toggle.checked 
                                        ? 'You will now appear in the leaderboard!' 
                                        : 'You have been hidden from the leaderboard.',
                                    'success'
                                );
                            } else {
                                // Revert toggle if update failed
                                toggle.checked = !toggle.checked;
                                showMessage('Failed to update privacy settings. Please try again.', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('Error updating privacy settings:', error);
                        // Revert toggle if error occurred
                        toggle.checked = !toggle.checked;
                        showMessage('Error updating privacy settings. Please try again.', 'error');
                    }
                });
            }

            // Initialize privacy settings
            setTimeout(initializePrivacySettings, 1000);
        });

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                ${type === 'success' 
                    ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' 
                    : 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
                }
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 4000);
        }
        </script>
    </body>
</html>